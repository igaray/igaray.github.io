<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Global Site Tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-59055167-2"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments)};
          gtag('js', new Date());

          gtag('config', 'UA-59055167-2');
        </script>

        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://notes.shichao.io/tcpv1/ch7/">
        <link rel="shortcut icon" href="../../toki_32.png">
        

	<title>Chapter 7. Firewalls and Network Address Translation (NAT) - Shichao's Notes</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,400italic,500,600" rel="stylesheet">
        <link href="../../custom.css" rel="stylesheet">
        <link href="../../friendly.css" rel="stylesheet">
        <link href="../../theme.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Shichao's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">APUE <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../apue/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch1/">Chapter 1. UNIX System Overview</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch2/">Chapter 2. UNIX Standardization and Implementations</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch3/">Chapter 3. File I/O</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch4/">Chapter 4. Files and Directories</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch5/">Chapter 5. Standard I/O Library</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch6/">Chapter 6. System Data Files and Information</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch7/">Chapter 7. Process Environment</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch8/">Chapter 8. Process Control</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch9/">Chapter 9. Process Relationships</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch10/">Chapter 10. Signals</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch11/">Chapter 11. Threads</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch12/">Chapter 12. Thread Control</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch13/">Chapter 13. Daemon Processes</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch14/">Chapter 14. Advanced I/O</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch15/">Chapter 15. Interprocess Communication</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch16/">Chapter 16. Network IPC: Sockets</a>
                        </li>
                      
                        <li>
                            <a href="../../apue/ch17/">Chapter 17. Advanced IPC</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UNP <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../unp/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch1/">Chapter 1. Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch2/">Chapter 2. The Transport Layer: TCP, UDP, and SCTP</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch3/">Chapter 3. Sockets Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch4/">Chapter 4. Elementary TCP Sockets</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch5/">Chapter 5. TCP Client/Server Example</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch6/">Chapter 6. I/O Multiplexing: The select and poll Functions</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch7/">Chapter 7. Socket Options</a>
                        </li>
                      
                        <li>
                            <a href="../../unp/ch8/">Chapter 8. Elementary UDP Sockets</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">TCPv1 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../ch1/">Chapter 1. Introduction</a>
                        </li>
                      
                        <li>
                            <a href="../ch2/">Chapter 2. The Internet Address Architecture</a>
                        </li>
                      
                        <li>
                            <a href="../ch3/">Chapter 3. Link Layer</a>
                        </li>
                      
                        <li>
                            <a href="../ch4/">Chapter 4. ARP: Address Resolution Protocol</a>
                        </li>
                      
                        <li>
                            <a href="../ch5/">Chapter 5. The Internet Protocol (IP)</a>
                        </li>
                      
                        <li>
                            <a href="../ch6/">Chapter 6. System Configuration: DHCP and Autoconfiguration</a>
                        </li>
                      
                        <li class="active">
                            <a href="./">Chapter 7. Firewalls and Network Address Translation (NAT)</a>
                        </li>
                      
                        <li>
                            <a href="../ch8/">Chapter 8. ICMPv4 and ICMPv6: Internet Control Message Protocol</a>
                        </li>
                      
                        <li>
                            <a href="../ch9/">Chapter 9. Broadcasting and Local Multicasting (IGMP and MLD)</a>
                        </li>
                      
                        <li>
                            <a href="../ch10/">Chapter 10. User Datagram Protocol (UDP) and IP Fragmentation</a>
                        </li>
                      
                        <li>
                            <a href="../ch11/">Chapter 11. Name Resolution and the Domain Name System (DNS)</a>
                        </li>
                      
                        <li>
                            <a href="../ch12/">Chapter 12. TCP: The Transmission Control Protocol (Preliminaries)</a>
                        </li>
                      
                        <li>
                            <a href="../ch13/">Chapter 13. TCP Connection Management</a>
                        </li>
                      
                        <li>
                            <a href="../ch14/">Chapter 14. TCP Timeout and Retransmission</a>
                        </li>
                      
                        <li>
                            <a href="../ch15/">Chapter 15. TCP Data Flow and Window Management</a>
                        </li>
                      
                        <li>
                            <a href="../ch16/">Chapter 16. TCP Congestion Control</a>
                        </li>
                      
                        <li>
                            <a href="../ch17/">Chapter 17. TCP Keepalive</a>
                        </li>
                      
                        <li>
                            <a href="../ch18/">Chapter 18. Security: EAP, IPsec, TLS, DNSSEC, and DKIM</a>
                        </li>
                      
                        <li>
                            <a href="../headers/">Headers</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">GOPL <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../gopl/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch1/">Chapter 1. Tutorial</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch2/">Chapter 2. Program Structure</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch3/">Chapter 3. Basic Data Types</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch4/">Chapter 4. Composite Types</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch5/">Chapter 5. Functions</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch6/">Chapter 6. Methods</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch7/">Chapter 7. Interfaces</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch8/">Chapter 8. Goroutines and Channels</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch9/">Chapter 9. Concurrency with Shared Variables</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch10/">Chapter 10. Packages and the Go Tool</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch11/">Chapter 11. Testing</a>
                        </li>
                      
                        <li>
                            <a href="../../gopl/ch12/">Chapter 12. Reflection</a>
                        </li>
                      
                    </ul>
                </li>
            <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">CSN <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li>
                            <a href="../../csn/">Contents</a>
                        </li>
                      
                        <li>
                            <a href="../../csn/part1/">Part 1: Language</a>
                        </li>
                      
                        <li>
                            <a href="../../csn/part2/">Part 2: Advanced</a>
                        </li>
                      
                    </ul>
                </li>
            <li>
                    <a href="../../toc/">TOC</a>
                </li>
            </ul>
            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    
                        <a href="https://github.com/shichao-an/notes/blob/master/docs/tcpv1/ch7.md">
                    
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#chapter-7-firewalls-and-network-address-translation-nat">Chapter 7. Firewalls and Network Address Translation (NAT)</a></li>
        
    
        <li class="main "><a href="#firewalls">Firewalls</a></li>
        
            <li><a href="#packet-filtering-firewalls">Packet-Filtering Firewalls</a></li>
        
            <li><a href="#proxy-firewalls">Proxy Firewalls</a></li>
        
    
        <li class="main "><a href="#network-address-translation-nat">Network Address Translation (NAT)</a></li>
        
            <li><a href="#traditional-nat-basic-nat-and-napt">Traditional NAT: Basic NAT and NAPT</a></li>
        
            <li><a href="#address-and-port-translation-behavior">Address and Port Translation Behavior</a></li>
        
            <li><a href="#filtering-behavior">Filtering Behavior</a></li>
        
            <li><a href="#servers-behind-nats">Servers behind NATs</a></li>
        
            <li><a href="#hairpinning-and-nat-loopback">Hairpinning and NAT Loopback</a></li>
        
            <li><a href="#nat-editors">NAT Editors</a></li>
        
            <li><a href="#service-provider-nat-spnat-and-service-provider-ipv6-transition">Service Provider NAT (SPNAT) and Service Provider IPv6 Transition</a></li>
        
    
        <li class="main "><a href="#nat-traversal">NAT Traversal</a></li>
        
    
        <li class="main "><a href="#doubts-and-solutions">Doubts and Solutions</a></li>
        
            <li><a href="#verbatim">Verbatim</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">
              

<h3 id="chapter-7-firewalls-and-network-address-translation-nat"><strong>Chapter 7. Firewalls and Network Address Translation (NAT)</strong><a class="headerlink" href="#chapter-7-firewalls-and-network-address-translation-nat" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Perhaps ironically, the development and eventual widespread use of NAT has contributed to significantly slow the adoption of IPv6.
<small><em>TCPv1</em></small></p>
</blockquote>
<p>Many security problems (attacks) were caused by bugs or unplanned protocol operations in the software implementations of Internet hosts. Fixing the problem would have required a way to control the Internet traffic to which the end hosts were exposed. Today, this is provided by a <strong>firewall</strong>, a type of router that restricts the types of traffic it forwards. [p299]</p>
<p>As firewalls are being deployed, another problem was becoming important: the number of available IPv4 addresses was diminishing,
with a threat of exhaustion. One of the most important mechanisms developed to deal with this, aside from IPv6, is called <strong>Network Address Translation</strong> (NAT). With NAT, Internet addresses need not be globally unique, but can be reused in different parts of the Internet, called <em>address realms</em>. This greatly eased the problem of address exhaustion.</p>
<h3 id="firewalls">Firewalls<a class="headerlink" href="#firewalls" title="Permanent link">&para;</a></h3>
<p>Given the enormous management problems associated with trying to keep end system software up-to-date and bug-free, the focus of resisting attacks expanded</p>
<ul>
<li>From: securing end systems,</li>
<li>To: restricting the Internet traffic allowed to flow to end systems by filtering out some traffic using firewalls.</li>
</ul>
<p>Today, several different types of firewalls have evolved.</p>
<p>The two major types of firewalls commonly used include <strong>proxy firewalls</strong> and <strong>packet-filtering firewalls</strong>. The main difference between them is the layer in the protocol stack at which they operate, and consequently the way IP addresses and port numbers are used. The packet-filtering firewall is an Internet router that drops datagrams that (fail to) meet specific criteria. The proxy firewall operates as a multihomed server host from the viewpoint of an Internet client. That is, it is the endpoint of TCP and UDP transport associations; it does not typically route IP datagrams at the IP protocol layer.</p>
<h4 id="packet-filtering-firewalls">Packet-Filtering Firewalls<a class="headerlink" href="#packet-filtering-firewalls" title="Permanent link">&para;</a></h4>
<p>Packet-filtering firewalls act as Internet routers and filter (drop) some traffic. They can generally be configured to discard or forward packets whose headers meet (or fail to meet) certain criteria, called <em>filters</em>.</p>
<p>Popular filters involve:</p>
<ul>
<li>Undesired IP addresses or options,</li>
<li>Types of ICMP messages,</li>
<li>Various UDP or TCP services, based on the port numbers contained in each packet.</li>
</ul>
<p>Stateless and stateful:</p>
<ul>
<li><em>Stateless</em> firewalls treat each datagram individually.</li>
<li><em>Stateful</em> firewalls are able associate packets with either previous or future packets to make inferences about datagrams or streams.</li>
</ul>
<p>[p300]</p>
<p>A typical packet-filtering firewall is shown below.</p>
<p>In this figure</p>
<ul>
<li>The firewall is an Internet router with three network interfaces:<ul>
<li>"inside"</li>
<li>"outside"</li>
<li>"DMZ"</li>
</ul>
</li>
<li>The DMZ subnet provides access to an extranet or DMZ where servers are deployed for Internet users to access.</li>
<li>Network administrators install filters or <strong>access control lists</strong> (ACLs, basically policy lists indicating what types of packets to discard or forward) in the firewall.</li>
<li>Typically, these filters conservatively block traffic from the outside that may be harmful and liberally allow traffic to travel from inside to outside.</li>
</ul>
<p><a href="../figure_7-1.png" title="A typical packet-filtering firewall configuration. The firewall acts as an IP router between an “inside” and an “outside” network, and sometimes a third “DMZ” or extranet network, allowing only certain traffic to pass through it. A common configuration allows all traffic to pass from inside to outside but only a small subset of traffic to pass in the reverse direction. When a DMZ is used, only certain services are permitted to be accessed from the Internet."><img alt="A typical packet-filtering firewall configuration. The firewall acts as an IP router between an “inside” and an “outside” network, and sometimes a third “DMZ” or extranet network, allowing only certain traffic to pass through it. A common configuration allows all traffic to pass from inside to outside but only a small subset of traffic to pass in the reverse direction. When a DMZ is used, only certain services are permitted to be accessed from the Internet." src="../figure_7-1.png" /></a></p>
<h4 id="proxy-firewalls">Proxy Firewalls<a class="headerlink" href="#proxy-firewalls" title="Permanent link">&para;</a></h4>
<p>Proxy firewalls are not really Internet routers. They are essentially hosts running one or more <a href="https://en.wikipedia.org/wiki/Application-level_gateway"><strong>application-layer gateways</strong></a> (ALGs), hosts with more than one network interface that relay traffic of certain types between one connection/association and another at the application layer.</p>
<p>The figure below illustrates a proxy firewall:</p>
<ul>
<li>Clients on the inside of the firewall are usually configured in a special way to associate (or connect) with the proxy instead of the actual end host providing the desired service.</li>
<li>The firewalls act as multihomed hosts with their IP forwarding capability typically disabled.</li>
<li>As with packet-filtering firewalls, a common configuration is to have an "outside" interface assigned a globally routable IP address and for its "inner" interface to be configured with a private IP address. Thus, proxy firewalls support the use of private address realms.</li>
</ul>
<p><a href="../figure_7-2.png" title="The proxy firewall acts as a multihomed Internet host, terminating TCP connections and UDP associations at the application layer. It does not act as a conventional IP router but rather as an ALG. Individual applications or proxies for each service supported must be enabled for communication to take place through the proxy firewall."><img alt="The proxy firewall acts as a multihomed Internet host, terminating TCP connections and UDP associations at the application layer. It does not act as a conventional IP router but rather as an ALG. Individual applications or proxies for each service supported must be enabled for communication to take place through the proxy firewall." src="../figure_7-2_600.png" /></a></p>
<p>This type of firewall can be quite secure at the cost of brittleness and lack of flexibility:</p>
<ul>
<li>Since this style of firewall must contain a proxy for each transport-layer service, any new services to be used must have a corresponding proxy installed and operated for connectivity to take place through the proxy.</li>
<li>Each client must be configured to find the proxy, for example using the <a href="https://en.wikipedia.org/wiki/Web_Proxy_Autodiscovery_Protocol">Web Proxy Auto-Discovery Protocol</a> (WPAD), although there are some alternatives: capturing proxies that catch all traffic of a certain type regardless of destination address).</li>
<li>Significant intervention is required from network operators to support additional services.</li>
</ul>
<p>The two most common forms of proxy firewalls are HTTP proxy firewalls and SOCKS firewalls.</p>
<ul>
<li><strong>HTTP proxy firewalls</strong>, also called <strong>Web proxies</strong>, work only for the HTTP and HTTPS (Web) protocols.<ul>
<li>These proxies act as Web servers for internal clients and as Web clients when accessing external Web sites.</li>
<li>Such proxies often also operate as <strong>Web caches</strong>. These caches save copies of Web pages so that subsequent accesses can be served directly from the cache instead of from the originating Internet Web server. Doing so can reduce latency to display Web pages and improve the experience of users accessing the Web.</li>
<li>Some Web proxies are also used as <strong>content filters</strong>, which attempt to block access to certain Web sites based on a “blacklist” of prohibited sites. Conversely, <strong>tunneling proxy servers</strong> are available on the Internet. These servers (e.g., <a href="https://en.wikipedia.org/wiki/Psiphon">psiphon</a>, <a href="https://en.wikipedia.org/wiki/CGIProxy">CGIProxy</a>) essentially perform the opposite function: to allow users to avoid being blocked by content filters.</li>
</ul>
</li>
<li><strong>SOCKS firewalls</strong> uses the <a href="https://en.wikipedia.org/wiki/SOCKS">SOCKS protocol</a>, which is more generic than HTTP for proxy access and is applicable to more services than just the Web. Two versions of SOCKS are currently in use: version 4 (SOCKS5) and version 5 (SOCKS5). Version 4 provides the basic support for proxy traversal, and version 5 adds strong authentication, UDP traversal, and IPv6 addressing.<ul>
<li>To use a SOCKS proxy, an application must be written to use SOCKS (it must be "socksified") and configured to know the location and version of the SOCKS proxy. Then the client uses the SOCKS protocol to request the proxy to perform network connections and, optionally, DNS lookups.</li>
</ul>
</li>
</ul>
<h3 id="network-address-translation-nat">Network Address Translation (NAT)<a class="headerlink" href="#network-address-translation-nat" title="Permanent link">&para;</a></h3>
<p>NAT is a mechanism that allows the same sets of IP addresses to be reused in different parts of the Internet. With NAT as a common use, all incoming and outgoing traffic passes through a single NAT device that partitions the inside (private) address realm from the global Internet address realm, all the internal systems can be provided Internet connectivity as clients using locally assigned, private IP addresses. [p303]</p>
<p>NAT was introduced to solve two problems: address depletion and concerns regarding the scalability of routing. NAT was initially suggested as a stopgap, temporary measure to be used until the deployment of some protocol with a larger number of addresses (IPv6) became widespread. Routing scalability was being tackled with the development of Classless Inter-Domain Routing (CIDR, <a href="../ch2/">Chapter 2</a>)</p>
<p>NAT is popular because:</p>
<ol>
<li>It reduces the need for globally routable Internet addresses</li>
<li>It offers some degree of natural firewall capability and requires little configuration.</li>
</ol>
<p>Perhaps ironically, the development and eventual widespread use of NAT has contributed to significantly slow the adoption of IPv6. Among its other benefits, IPv6 was intended to make NAT unnecessary.</p>
<p>NAT has several drawbacks:</p>
<ul>
<li>Offering Internet-accessible services from the private side requires special configuration because privately addressed systems are not directly reachable from the Internet.</li>
<li>Every packet in both directions of a connection or association must pass through the same NAT, because the NAT must actively rewrite the addressing information in each packet.<ul>
<li>NATs require connection state on a <em>per-association</em> (or <em>per-connection</em>) basis and must operate across multiple protocol layers, unlike conventional routers. Modifying an address at the IP layer also requires modifying checksums at the transport layer (see <a href="../ch10/">Chapters 10</a> and <a href="../ch13/">Chatper 13</a> regarding the pseudoheader checksum)</li>
</ul>
</li>
<li>Some applications protocols, especially those that send IP addressing information inside the application-layer payload, such as <a href="https://en.wikipedia.org/wiki/File_Transfer_Protocol">File Transfer Protocol</a> (FTP) and <a href="https://en.wikipedia.org/wiki/Session_Initiation_Protocol">Session Initiation Protocol</a> (SIP), require a special application-layer gateway function that rewrites the application content in order to work unmodified with NAT or other NAT traversal methods that allow the applications to determine how to work with the specific NAT they are using.</li>
</ul>
<p>Despite its shortcomings, NATs are very widely used, and most network routers support it; NAT supports the basic protocols (e.g., e-mail, Web browsing) that are needed by millions of client systems accessing the Internet every day.</p>
<p>A NAT works by rewriting the identifying information in packets transiting through a router. Most commonly NAT involves rewriting the source IP address of packets as they are forwarded in one direction and the destination IP addresses of packets traveling in the reverse direction. This allows the source IP address in outgoing packets to become one of the NAT router’s Internet-facing interfaces instead of the originating host’s. Thus, <u>to a host on the Internet, packets coming from any of the hosts on the privately addressed side of the NAT appear to be coming from a globally routable IP address of the NAT router.</u></p>
<p>Most NATs perform both <em>translation</em> and <em>packet filtering</em>, and the packet-filtering criteria depend on the dynamics of the NAT state. The choice of packet-filtering policy may have a different granularity. For example, the treatment of unsolicited packets (those not associated with packets originating from behind the NAT) received by the NAT may depend on source and destination IP address and/or source and destination port number. [p305]</p>
<h4 id="traditional-nat-basic-nat-and-napt">Traditional NAT: Basic NAT and NAPT<a class="headerlink" href="#traditional-nat-basic-nat-and-napt" title="Permanent link">&para;</a></h4>
<p><strong>Traditional NAT</strong> includes both:</p>
<ul>
<li><strong>Basic NAT</strong>. It performs rewriting of IP addresses only: a private address is rewritten to be a public address, often from a pool or range of public addresses supplied. This type of NAT is not the most popular because it does not help to dramatically reduce the need for (globally routable) IP addresses.</li>
<li><strong>Network Address Port Translation</strong> (NAPT), also known as <strong>IP masquerading</strong>. It uses transport-layer identifiers (i.e., ports for TCP and UDP, query identifiers for ICMP) to differentiate which host on the private side of the NAT is associated with a particular packet. This allows a large number of internal hosts to access the Internet simultaneously using a limited number of public addresses, often only a single one.</li>
</ul>
<p>See the following figure for the distinction between basic NAT and NAPT:</p>
<p><a href="../figure_7-4.png" title="A basic IPv4 NAT (left) rewrites IP addresses from a pool of addresses and leaves port numbers unchanged. NAPT (right), also known as IP masquerading, usually rewrites address to a single address. NAPT must sometimes rewrite port numbers in order to avoid collisions. In this case, the second instance of port number 23479 was rewritten to use port number 3000 so that returning traffic for 192.168.1.2 could be distinguished from the traffic returning to 192.168.1.35."><img alt="A basic IPv4 NAT (left) rewrites IP addresses from a pool of addresses and leaves port numbers unchanged. NAPT (right), also known as IP masquerading, usually rewrites address to a single address. NAPT must sometimes rewrite port numbers in order to avoid collisions. In this case, the second instance of port number 23479 was rewritten to use port number 3000 so that returning traffic for 192.168.1.2 could be distinguished from the traffic returning to 192.168.1.35." src="../figure_7-4_600.png" /></a></p>
<p>The addresses used in a private addressing realm "behind" (or "inside") a NAT are not enforced by anyone other than the local network administrator. It is possible and acceptable for a private realm to make use of global address space. However, <u>local systems in the private realm would most likely be unable to reach the public systems using the same addresses because the close proximity of the local systems would effectively "mask" the visibility of the farther-away systems using the same addresses.</u> To avoid this, three IPv4 address ranges are reserved for use with private addressing realms: 10.0.0.0/8, 172.16.0.0/12, and 192.168.0.0/16, which are often used as default values for address pools in embedded DHCP servers</p>
<p>NAT provides some degree of security, similar to a firewall [p306]:</p>
<ul>
<li>By default, systems on the private side (using private addresses) of the NAT cannot be reached from the Internet.</li>
<li>A common policy allows almost all outgoing and returning traffic (associated with outgoing traffic) to pass through the NAT but blocks almost all incoming new connection requests. This behavior inhibits "probing" attacks that attempt to ascertain which IP addresses have active hosts available to exploit.</li>
<li>A NAT (especially a NAPT) "hides" the number and configuration of internal addresses from the outside. NAT helps by providing <strong>topology hiding</strong>.</li>
</ul>
<p>The following subsections discusses how NAT behaves with each major transport protocol and how it may be used in mixed IPv4/IPv6 environments. [p306]</p>
<h5 id="nat-and-tcp"><strong>NAT and TCP</strong><a class="headerlink" href="#nat-and-tcp" title="Permanent link">&para;</a></h5>
<p>When a TCP connection starts, an "active opener" or client usually sends a synchronization (SYN) packet to a "passive opener" or server. The server responds with its own SYN packet, which also includes an acknowledgment (ACK) of the client’s SYN.  The client then responds with an ACK to the server. This “three-way handshake” establishes the connection. A similar exchange with finish (FIN) packets is used to gracefully close a connection. The connection can also be forcefully closed right away using a reset (RST) packet. The behavioral requirements for traditional NAT with TCP relate primarily to the TCP three-way handshake.</p>
<p>Referring to the figure below, consider a TCP connection initiated by the wireless client at 10.0.0.126 destined for the Web server on the host <code>www.isoc.org</code> (IPv4 address 212.110.167.157). With the format "(source IP:source port; destination IP:destination port)", the packet initiating the connection on the private segment might be addressed as (10.0.0.126:9200; 212.110.167.157:80).</p>
<p><a href="../figure_7-3.png" title="A NAT isolates private addresses and the systems using them from the Internet. Packets with private addresses are not routed by the Internet directly but instead must be translated as they enter and leave the private network through the NAT router. Internet hosts see traffic as coming from a public IP address of the NAT."><img alt="A NAT isolates private addresses and the systems using them from the Internet. Packets with private addresses are not routed by the Internet directly but instead must be translated as they enter and leave the private network through the NAT router. Internet hosts see traffic as coming from a public IP address of the NAT." src="../figure_7-3_600.png" /></a></p>
<p>[p307]</p>
<ul>
<li>The NAT receives the first incoming packet from the client and notices it is a new connection (SYN bit in the TCP header is turned on).<ul>
<li>It modifies the source IP address to the routable IP address of the NAT router’s external interface. Thus, when the NAT forwards this packet, the addressing is (63.204.134.177:9200; 212.110.167.157:80).</li>
<li>It creates a <strong>NAT session</strong>, which is internal state to remember that a new connection is being handled by the NAT. This state includes an entry, called a <strong>NAT mapping</strong>, containing the source port number and IP address of the client.</li>
</ul>
</li>
<li>The server replies to the endpoint (63.204.134.177:9200), the external NAT address, using the port number chosen initially by the client. This behavior is called <strong>port preservation</strong>. By matching the destination port number on the received datagram against the NAT mapping, the NAT ascertains the internal IP address of the client that made the initial request. The NAT rewrites the response packet from (212.110.167.157:80; 63.204.134.177:9200) to (212.110.167.157:80; 10.0.0.126:9200) and forwards it.</li>
<li>The client then receives a response to its request and is now connected to the server.</li>
</ul>
<p>Session state is removed if FINs are exchanged. The NAT must also remove "dead" mappings (identified by lack of traffic or RST) that are left stale in the NAT's memory, such when a client host is simply turned off.</p>
<p>Most NATs include a simplified TCP connection establishment procedures and can distinguish between connection success and failure:</p>
<ul>
<li>A <strong>connection timer</strong> is activated when an outgoing SYN segment is observed, and if no ACK is seen before the timer expires, the session state is cleared.</li>
<li>A <strong>session timer</strong> is created, with a longer timeout (hours), after an ACK does arrives and the connection timer is canceled.<ul>
<li>The NAT may send an additional packet to the internal endpoint to doublecheck if the session is indeed dead (called <em>probing</em>). If it receives an ACK, the NAT realizes that the connection is still active, resets the session timer, and does not delete the session. If it receives either no response (after a <strong>close timer</strong> has expired) or an RST segment, the connection has gone dead, and the state is cleared.</li>
</ul>
</li>
</ul>
<p>A TCP connection can be configured to send "keepalive" packets (<a href="../ch17/">Chapter 17</a>), and the default rate is one packet every 2 hours, if enabled. Otherwise, a TCP connection can remain established indefinitely. While a connection is being set up or cleared, however, the maximum idle time is 4 minutes. Consequently, [RFC5382] requires (REQ-5) that a NAT wait at least 2 hours and 4 minutes before concluding that an established connection is dead and at least 4 minutes before concluding that a partially opened or closed connection is dead.</p>
<p>There are tricky problems for TCP NAT. [p308] See <a href="#doubts-and-solutions">Doubts and Solutions</a></p>
<h5 id="nat-and-udp"><strong>NAT and UDP</strong><a class="headerlink" href="#nat-and-udp" title="Permanent link">&para;</a></h5>
<p>Besides issues when performing NAT on TCP, the NAT on UDP has other issues due to:</p>
<ul>
<li>UDP has no connection establishment and clearing procedures as in TCP.</li>
<li>There are no indicators such as the SYN, FIN, and RST bits to indicate that a session is being created or destroyed.</li>
<li>An association may not be completely clear: UDP does not use a 4-tuple to identify a connection like TCP; it can rely on only the two endpoint address/port number combinations.</li>
</ul>
<p>To handle these issues, UDP NATs use a <strong>mapping timer</strong> to clear NAT state if a binding has not been used "recently". The "recently" may mean different values. [RFC4787] requires the timer to be at least 2 minutes and recommends that it be 5 minutes. Timers can be refreshed when packets travel from the inside to the outside of the NAT (NAT outbound refresh behavior). [p309]</p>
<p>With IP fragmentation, an IP fragment other than the first one does not contain the port number information needed by NAPT to operate properly. This also applies to TCP and ICMP. Thus, fragments cannot be handled properly by simple NATs or NAPTs. [p309]</p>
<h5 id="nat-and-other-transport-protocols-dccp-sctp"><strong>NAT and Other Transport Protocols (DCCP, SCTP)</strong><a class="headerlink" href="#nat-and-other-transport-protocols-dccp-sctp" title="Permanent link">&para;</a></h5>
<ul>
<li>The <a href="https://en.wikipedia.org/wiki/Datagram_Congestion_Control_Protocol">Datagram Congestion Control Protocol</a> (DCCP) [RFC4340] provides a congestion-controlled datagram service.</li>
<li>The <a href="https://en.wikipedia.org/wiki/Stream_Control_Transmission_Protocol">Stream Control Transmission Protocol</a> (SCTP) [RFC4960] provides a reliable messaging service that can accommodate hosts with multiple addresses.</li>
</ul>
<h5 id="nat-and-icmp"><strong>NAT and ICMP</strong><a class="headerlink" href="#nat-and-icmp" title="Permanent link">&para;</a></h5>
<p>The Internet Control Message Protocol (ICMP) provides status information about IP packets and can also be used for making certain measurements and gathering information about the state of the network.</p>
<p>ICMP has two categories of messages: informational and error: [p310]</p>
<ul>
<li>Error messages contain a (partial or full) copy of the IP packet that induced the error condition. They are sent from the point where an error was detected, often in the middle of the network, to the original sender.<ul>
<li>When an ICMP error message passes through a NAT, the IP addresses in the included "offending datagram" need to be rewritten by the NAT in order for them to make sense to the end client (called <strong>ICMP fix-up</strong>).</li>
</ul>
</li>
<li>Informational messages include a <em>Query ID</em> field that is handled much like port numbers for TCP or UDP.<ul>
<li>NAT handling these types of messages can recognize outgoing informational requests and set a timer in anticipation of a returning response.</li>
</ul>
</li>
</ul>
<h5 id="nat-and-tunneled-packets"><strong>NAT and Tunneled Packets</strong><a class="headerlink" href="#nat-and-tunneled-packets" title="Permanent link">&para;</a></h5>
<p>When tunneled packets (<a href="../ch3/">Chapter 3</a>) are to be sent through a NATs, not only must a NAT rewrite the IP header, but it may also have to rewrite the headers or payloads of other packets that are encapsulated in them. One example of this is the <a href="https://en.wikipedia.org/wiki/Generic_Routing_Encapsulation">Generic Routing Encapsulation</a> (GRE) header used with the <a href="https://en.wikipedia.org/wiki/Point-to-Point_Tunneling_Protocol">Point-to-Point Tunneling Protocol</a> (PPTP). [p310]</p>
<h5 id="nat-and-multicast"><strong>NAT and Multicast</strong><a class="headerlink" href="#nat-and-multicast" title="Permanent link">&para;</a></h5>
<p>NATs can be configured to support multicast traffic (<a href="../ch9/">Chapter 9</a>), although this is rare. [p310]</p>
<h5 id="nat-and-ipv6"><strong>NAT and IPv6</strong><a class="headerlink" href="#nat-and-ipv6" title="Permanent link">&para;</a></h5>
<p>There is staunch resistance to supporting the use of NAT with IPv6 based on the idea that saving address space is unnecessary with IPv6 and that other desirable NAT features (firewall-like functionality, topology hiding, and privacy) can be better achieved using Local Network Protection (LNP) [RFC4864]. LNP represents a collection of techniques with IPv6 that match or exceed the properties of NATs.</p>
<p>Aside from its packet-filtering properties, NAT supports the coexistence of multiple address realms and thereby helps to avoid the problem of a site having to change its IP addresses when it switches ISPs. [p310-311]</p>
<h4 id="address-and-port-translation-behavior">Address and Port Translation Behavior<a class="headerlink" href="#address-and-port-translation-behavior" title="Permanent link">&para;</a></h4>
<p>One of the primary goals of the BEHAVE working group in IETF was to clarify the common behaviors and set guidelines. [p311]</p>
<p>See the following figure as a generic NAT mapping example:</p>
<p><a href="../figure_7-5.png" title=" A NAT’s address and port behavior is characterized by what its mappings depend on.  The inside host uses IP address:port X:x to contact Y1:y1 and then Y2:y2. The address and port used by the NAT for these associations are X1′:x1′ and X2′:x2′, respectively. If X1′:x1′ equals X2′:x2′ for any Y1:y1 or Y2:y2, the NAT has endpoint-independent mappings. If X1′:x1′ equals X2′:x2′ if and only if Y1 equals Y2, the NAT has address-dependent mappings.  If X1′:x1′ equals X2′:x2′ if and only if Y1:y1 equals Y2:y2, the NAT has addressand port-dependent mappings. A NAT with multiple external addresses (i.e., where X1′ may not equal X2′) has an address pooling behavior of arbitrary if the outside address is chosen without regard to inside or outside address. Alternatively, it may have a pooling behavior of paired, in which case the same X1 is used for any association with Y1."><img alt=" A NAT’s address and port behavior is characterized by what its mappings depend on.  The inside host uses IP address:port X:x to contact Y1:y1 and then Y2:y2. The address and port used by the NAT for these associations are X1′:x1′ and X2′:x2′, respectively. If X1′:x1′ equals X2′:x2′ for any Y1:y1 or Y2:y2, the NAT has endpoint-independent mappings. If X1′:x1′ equals X2′:x2′ if and only if Y1 equals Y2, the NAT has address-dependent mappings.  If X1′:x1′ equals X2′:x2′ if and only if Y1:y1 equals Y2:y2, the NAT has addressand port-dependent mappings. A NAT with multiple external addresses (i.e., where X1′ may not equal X2′) has an address pooling behavior of arbitrary if the outside address is chosen without regard to inside or outside address. Alternatively, it may have a pooling behavior of paired, in which case the same X1 is used for any association with Y1." src="../figure_7-5_600.png" /></a></p>
<p>In this figure:</p>
<ul>
<li>The notation <em>X:x</em> indicates that a host in the private addressing realm (inside host) uses IP address <em>X</em> with port number <em>x</em> (for ICMP, the query ID is used instead of the port number). The IP address <em>X</em> is a private IPv4 address.</li>
<li>To reach the remote address/port combination <em>Y:y</em>, the NAT establishes a mapping using an external (globally routable) address <em>X1′</em> and port number <em>x1′</em>. Assuming that the internal host contacts <em>Y1:y1</em> followed by <em>Y2:y2</em>, the NAT establishes mappings <em>X1′:x1′</em> and <em>X2′:x2′</em>, respectively.<ul>
<li>In most cases, X1′ equals X2′ because most sites use only a single globally routable IP address.</li>
<li>The mapping is said to be <em>reused</em> if <em>x1′</em> equals <em>x2′</em>. If <em>x1′</em> and <em>x2′</em> equal <em>x</em>, the NAT implements port preservation, as <a href="#nat-and-tcp">mentioned earlier</a>. In some cases, port preservation is not possible, so the NAT must deal with port collisions as suggested by <a href="../figure_7-4.png">Figure 7-4</a>.</li>
</ul>
</li>
</ul>
<p>A NAT’s address and port behavior is characterized by what its mappings depend on.  The inside host uses IP address:port <em>X:x</em> to contact <em>Y1:y1</em> and then <em>Y2:y2</em>. The address and port used by the NAT for these associations are <em>X1′:x1′</em> and <em>X2′:x2′</em>, respectively.</p>
<ul>
<li>If <em>X1′:x1′</em> equals <em>X2′:x2′</em> for any <em>Y1:y1</em> or <em>Y2:y2</em>, the NAT has <strong>endpoint-independent</strong> mappings.</li>
<li>If <em>X1′:x1′</em> equals <em>X2′:x2′</em> if and only if <em>Y1</em> equals <em>Y2</em>, the NAT has <strong>address-dependent</strong> mappings.</li>
<li>If <em>X1′:x1′</em> equals <em>X2′:x2′</em> if and only if <em>Y1:y1</em> equals <em>Y2:y2</em>, the NAT has <strong>address and port-dependent</strong> mappings.</li>
</ul>
<p>A NAT with multiple external addresses (i.e., where <em>X1′</em> may not equal <em>X2′</em>) has an address pooling behavior of arbitrary if the outside address is chosen without regard to inside or outside address. Alternatively, it may have a pooling behavior of paired, in which case the same <em>X1</em> is used for any association with <em>Y1</em>.</p>
<p>The figure above and the table below summarize the various NAT port and address behaviors based on definitions from [RFC4787]. The table also gives filtering behaviors that use similar terminology.</p>
<p><u>For all common transports, including TCP and UDP, the required NAT address- and port-handling behavior is endpoint-independent.</u> The purpose of this requirement is to help applications that attempt to determine the external addresses used for their traffic to work more reliably. This is detailed in <a href="#nat-traversal">NAT traversal</a>.</p>
<table>
<thead>
<tr>
<th>Behavior Name</th>
<th>Translation Behavior</th>
<th>Filtering Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>Endpoint-independent</td>
<td><em>X1′:x1′ = X2′:x2′</em> for all <em>Y2:y2</em> (required)</td>
<td>Allows any packets for <em>X1:x1</em> as long as any <em>X1′:x1′</em> exists (recommended for greatest transparency)</td>
</tr>
<tr>
<td>Address-dependent</td>
<td><em>X1′:x1′ = X2′:x2′</em> iff <em>Y1 = Y2</em></td>
<td>Allows packets for <em>X1:x1</em> from <em>Y1:y1</em> as long as <em>X1</em> has previously contacted <em>Y1</em> (recommended for more stringent filtering)</td>
</tr>
<tr>
<td>Address-and port-dependent</td>
<td><em>X1′:x1′ = X2′:x2′</em> iff <em>Y1:y1 = Y2:y2</em></td>
<td>Allows packets for <em>X1:x1</em> from <em>Y1:y1</em> as long as <em>X1</em> has previously contacted <em>Y1:y1</em></td>
</tr>
</tbody>
</table>
<h5 id="nat-address-pool"><strong>NAT address pool</strong> *<a class="headerlink" href="#nat-address-pool" title="Permanent link">&para;</a></h5>
<p>A NAT may have several external addresses available to use. The set of addresses is typically called the <strong>NAT pool</strong> or <strong>NAT address pool</strong>. Note that NAT address pools are distinct from the DHCP address pools discussed in <a href="../ch6/">Chapter 6</a>, although a single device may need to handle both NAT and DHCP address pools.</p>
<h5 id="address-pairing-or-not"><strong>Address pairing or not?</strong> *<a class="headerlink" href="#address-pairing-or-not" title="Permanent link">&para;</a></h5>
<p>When a single host behind the NAT opens multiple simultaneous connections, is each assigned the same external IP address (called address <em>pairing</em>) or not?</p>
<p>A NAT’s <strong>IP address pooling behavior</strong> is said to be <em>arbitrary</em> if there is no restriction on which external address is used for any association. It is said to be paired if it implements address pairing. Pairing is the recommended NAT behavior for all transports. If pairing is not used, the communication peer of an internal host may erroneously conclude that it is communicating with different hosts. For NATs with only a single external address, this is obviously not a problem.</p>
<h5 id="port-overloading"><strong>Port overloading</strong> *<a class="headerlink" href="#port-overloading" title="Permanent link">&para;</a></h5>
<p><strong>Port overloading</strong> is a type of NAT that overloads not only addresses but also ports, where the traffic of multiple internal hosts may be rewritten to the same external IP address and port number. This is a dangerous because if multiple hosts associate with a service on the same external host, it cannot determine the appropriate destination for traffic returning from the external host. For TCP, this is a consequence of all four elements of the connection identifier (source and destination address and port numbers) being identical in the external network among the various connections. Such behavior
is now disallowed.</p>
<h5 id="port-parity"><strong>Port parity</strong> *<a class="headerlink" href="#port-parity" title="Permanent link">&para;</a></h5>
<p>Some NATs implement a special feature called <strong>port parity</strong>. Such NATs attempt to preserve the "parity" (evenness or oddness) of port numbers. Thus, if <em>x1</em> is even, <em>x1′</em> is even and vice versa. Although not as strong as port preservation, such behavior is sometimes useful for specific application protocols that use special port numberings (e.g., the Real-Time Protocol, abbreviated RTP, has traditionally used multiple ports, but there are proposed methods for avoiding this issue).</p>
<p>Port parity preservation is a recommended NAT feature but not a requirement. It is also expected to become less important over time as more sophisticated <a href="#nat-traversal">NAT traversal</a> methods become widespread.</p>
<h4 id="filtering-behavior">Filtering Behavior<a class="headerlink" href="#filtering-behavior" title="Permanent link">&para;</a></h4>
<p>When a NAT creates a binding for a TCP connection, UDP association, or ICMP traffic, not only does it establish the address and port mappings, but it must also determine its filtering behavior for the returning traffic if it acts as a firewall, which is the common case. The type of filtering a NAT performs, though logically distinct from its address- and port-handling behavior, is often related and the same terminology is used.</p>
<p>A NAT’s filtering behavior is usually related to whether it has established an address mapping. A NAT lacking any form of address mapping is unable to forward any traffic it receives from the outside to the inside because it would not know which internal destination to use. For the most common case of outgoing traffic, when a binding is established, filtering is disabled for relevant return traffic:</p>
<ul>
<li>For endpoint-independent filtering behavior, as soon as any mapping is established for an internal host, any incoming traffic is permitted, regardless of source.</li>
<li>For address-dependent filtering behavior, traffic destined for <em>X1:x1</em> is permitted from <em>Y1:y1</em> only if <em>Y1</em> had been previously contacted by <em>X1:x1</em>.</li>
<li>For address- and port-dependent filtering behavior, traffic destined for <em>X1:x1</em> is permitted from <em>Y1:y1</em> only if <em>Y1:y1</em> had been previously contacted by <em>X1:x1</em>.</li>
</ul>
<p>The difference between the last two is that the last form takes the port number <em>y1</em> into account.</p>
<h4 id="servers-behind-nats">Servers behind NATs<a class="headerlink" href="#servers-behind-nats" title="Permanent link">&para;</a></h4>
<p>A system that wishes to provide a service from behind a NAT is not directly reachable from the outside. In <a href="../figure_7-3.png">Figure 7-3</a>, if the host with address 10.0.0.3 is to provide a service to the Internet, it cannot be reached without participation from the NAT, for at least two reasons:</p>
<ol>
<li>The NAT is acting as the Internet router, so it must agree to forward the incoming traffic destined for 10.0.0.3.</li>
<li>The IP address 10.0.0.3 is not routable through the Internet and cannot be used to identify the server by hosts in the Internet. Instead, the external address of the NAT must be used to find the server, and the NAT must arrange to properly rewrite and forward the appropriate traffic to the server so that it can operate. This process is most often called <strong>port forwarding</strong> or <strong>port mapping</strong>.</li>
</ol>
<h5 id="port-forwarding"><strong>Port forwarding</strong> *<a class="headerlink" href="#port-forwarding" title="Permanent link">&para;</a></h5>
<p>With port forwarding, incoming traffic to a NAT is forwarded to a specific configured destination behind the NAT. This allows servers to provide services to the Internet even though they may be assigned private, nonroutable addresses.</p>
<p>Port forwarding typically requires static configuration of the NAT with the address of the server and the associated port number whose traffic should be forwarded. The port forwarding directive acts like an always-present static NAT mapping. If the server’s IP address is changed, the NAT must be updated with the new addressing information.</p>
<p>Port forwarding also has the limitation that it has only one set of port numbers for each of its (IP address, transport protocol) combinations. Thus, if the NAT has only a single external IP address, it can forward only a single port of the same transport protocol to at most one internal machine (e.g., it could not support two independent Web servers on the inside being remotely accessible using TCP port 80 from the outside).</p>
<h4 id="hairpinning-and-nat-loopback">Hairpinning and NAT Loopback<a class="headerlink" href="#hairpinning-and-nat-loopback" title="Permanent link">&para;</a></h4>
<p>An interesting issue arises when a client wishes to reach a server and both reside on the same, private side of the same NAT. NATs that support this scenario implement so-called <a href="https://en.wikipedia.org/wiki/Hairpinning"><strong>hairpinning</strong></a> or <a href="https://en.wikipedia.org/wiki/Network_address_translation#NAT_loopback"><strong>NAT loopback</strong></a>.</p>
<p><a href="../figure_7-6.png" title=" A NAT that implements hairpinning or NAT loopback allows a client to reach a server on the same side of the NAT using the server’s external IP address and port numbers. That is, X1 can reach X2:x2 using the addressing information X2′:x2′"><img alt=" A NAT that implements hairpinning or NAT loopback allows a client to reach a server on the same side of the NAT using the server’s external IP address and port numbers. That is, X1 can reach X2:x2 using the addressing information X2′:x2′" src="../figure_7-6.png" /></a></p>
<p>Referring to the figure above, assume that host <em>X1</em> attempts to establish a connection to host <em>X2</em>. If <em>X1</em> knows the private addressing information, <em>X2:x2</em>, there is no problem because the connection can be made directly. However, in some cases <em>X1</em> knows only the public address information, <em>X2′:x2′</em>. In these cases, <em>X1</em> attempts to contact <em>X2</em> using the NAT with destination <em>X2′:x2′</em>. The hairpinning process takes place when the NAT notices the existence of the mapping between <em>X2′:x2′</em> and <em>X2:x2</em> and forwards the packet to <em>X2:x2</em> residing on the private side of the NAT. At this point a question arises as to which source address is contained in the packet heading to <em>X2:x2</em>: <em>X1:x1</em> or <em>X1′:x1′</em>?</p>
<p>If the NAT presents the hairpinned packet to <em>X2</em> with source addressing information <em>X1′:x1′</em>, the NAT is said to have "external source IP address and port" hairpinning behavior. This behavior is required for TCP NAT [RFC5382]. The justification for requiring this behavior is for applications that identify their peers using globally routable addresses. In our example, <em>X2</em> may be expecting an incoming connection from <em>X1′</em> (e.g., because of coordination from a third-party system).</p>
<h4 id="nat-editors">NAT Editors<a class="headerlink" href="#nat-editors" title="Permanent link">&para;</a></h4>
<h4 id="service-provider-nat-spnat-and-service-provider-ipv6-transition">Service Provider NAT (SPNAT) and Service Provider IPv6 Transition<a class="headerlink" href="#service-provider-nat-spnat-and-service-provider-ipv6-transition" title="Permanent link">&para;</a></h4>
<h3 id="nat-traversal">NAT Traversal<a class="headerlink" href="#nat-traversal" title="Permanent link">&para;</a></h3>
<h3 id="doubts-and-solutions">Doubts and Solutions<a class="headerlink" href="#doubts-and-solutions" title="Permanent link">&para;</a></h3>
<h4 id="verbatim">Verbatim<a class="headerlink" href="#verbatim" title="Permanent link">&para;</a></h4>
<p>p308 on TCP NAT:</p>
<p class="text-muted">One of the tricky problems for a TCP NAT is handling peer-to-peer applications operating on hosts residing on the private sides of multiple NATs [RFC5128].  Some of these applications use a simultaneous open whereby each end of the connection acts as a client and sends SYN packets more or less simultaneously. TCP is able to handle this case by responding with SYN + ACK packets that complete the connection faster than with the three-way handshake, but many existing NATs do not handle it properly. [RFC5382] addresses this by requiring (REQ-2) that a NAT handle all valid TCP packet exchanges, and simultaneous opens in particular.  Some peer-to-peer applications (e.g., network games) use this behavior. In addition, [RFC5382] specifies that an inbound SYN for a connection about which the NAT knows nothing should be silently discarded. This can occur when a simultaneous open is attempted but the external host’s SYN arrives at the NAT before the internal host’s SYN. Although this may seem unlikely, it can happen as a result of clock skew, for example. If the incoming external SYN is dropped, the internal SYN has time to establish a NAT mapping for the same connection represented by the external SYN. If no internal SYN is forthcoming in 6s, the NAT may signal an error to the external host.</p>

<p>Some other NAT drawbacks:</p>
<ul>
<li><a href="https://www.excentis.com/blog/ugly-side-nat">The ugly side of NAT</a></li>
</ul>
            </div>
        </div>

        <footer class="col-md-12">
            
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../custom.js"></script>
    </body>
</html>